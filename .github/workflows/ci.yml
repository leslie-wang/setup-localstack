name: LocalStack Test
on:
  push:
    paths-ignore:
      - ./*.md
      - LICENSE
  pull_request:
    paths-ignore:
      - ./*.md
      - LICENSE
  workflow_dispatch:
  schedule:
    - cron: '48 23 * * 0'

jobs:
  localstack-action-test:
    name: 'Test LocalStack GitHub Action'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # We must hack the action call as remote to be able to use the relative paths
      # Could it break with different CWD? ü§î
      - name: Start LocalStack
        uses: jenseng/dynamic-uses@v1
        with:
          uses: LocalStack/setup-localstack@${{ env.action-version }}
          with: |-
            {
              "image-tag": "latest",
              "install-awslocal": "true",
              "configuration": "DEBUG=1",
              "use-pro": "true",
            }
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          action-version: ${{ fromJSON(format('["{0}","{1}"]', github.ref_name, github.head_ref))[github.event_name == 'pull_request'] }}

      - name: Run Tests against LocalStack
        run: |
          awslocal s3 mb s3://test
          awslocal s3 ls
          echo "Test Execution complete!"

  cloud-pods-test:
    name: 'Test Cloud Pods Action'
    runs-on: ubuntu-latest
    steps:
      - name: ‚ö°Ô∏è Checkout the repository
        uses: actions/checkout@v3

      - name: Start LocalStack
        uses: jenseng/dynamic-uses@v1
        with:
          uses: LocalStack/setup-localstack@${{ env.action-version }}
          with: |-
            {
              "image-tag": "latest",
              "install-awslocal": "true",
              "configuration": "DEBUG=1",
              "use-pro": "true",
            }
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          action-version: ${{ fromJSON(format('["{0}","{1}"]', github.ref_name, github.head_ref))[github.event_name == 'pull_request'] }}

      - name: Run AWS commands
        run: |
          awslocal s3 mb s3://test
          awslocal sqs create-queue --queue-name test-queue

      - name: Save the Cloud Pod 
        uses: jenseng/dynamic-uses@v1
        with:
          uses: LocalStack/setup-localstack@${{ env.action-version }}
          with: |-
            {
              "state-name": "cloud-pods-test",
              "state-action": "save",
              "skip-startup": "true",
            }
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          action-version: ${{ fromJSON(format('["{0}","{1}"]', github.ref_name, github.head_ref))[github.event_name == 'pull_request'] }}

  local-state-test:
    name: 'Test Local State Action'
    runs-on: ubuntu-latest
    steps:
      - name: ‚ö°Ô∏è Checkout the repository
        uses: actions/checkout@v3

      - name: Start LocalStack
        uses: jenseng/dynamic-uses@v1
        with:
          uses: LocalStack/setup-localstack@${{ env.action-version }}
          with: |-
            {
              "image-tag": "latest",
              "install-awslocal": "true",
              "configuration": "DEBUG=1",
              "use-pro": "true",
            }
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          action-version: ${{ fromJSON(format('["{0}","{1}"]', github.ref_name, github.head_ref))[github.event_name == 'pull_request'] }}

      - name: Run AWS commands
        run: |
          awslocal s3 mb s3://test
          awslocal sqs create-queue --queue-name test-queue

      - name: Save the Cloud Pod 
        uses: jenseng/dynamic-uses@v1
        with:
          uses: LocalStack/setup-localstack@${{ env.action-version }}
          with: |-
            {
              "state-name": "cloud-pods-test",
              "state-action": "save",
              "state-backend": "local",
              "skip-startup": "true",
            }
        env:
          LOCALSTACK_API_KEY: ${{ secrets.LOCALSTACK_API_KEY }}
          action-version: ${{ fromJSON(format('["{0}","{1}"]', github.ref_name, github.head_ref))[github.event_name == 'pull_request'] }}
